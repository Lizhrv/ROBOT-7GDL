<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot 7GDL - Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #0f0c29 0%, #302b63 100%);
            --secondary-bg: #1a1a2e;
            --accent-color-1: #00f0ff;
            --accent-color-2: #ff007f;
            --button-green: #39ff14;
            --button-blue: #00bfff;
            --button-red: #ff073a;
            --text-light: #e0e0e0;
            --text-dark: #121212;
            --shadow-light: rgba(0, 240, 255, 0.4);
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            background: var(--primary-bg);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background-color: var(--secondary-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 40px var(--shadow-light); 
            width: 100%;
            max-width: 900px;
            border: 2px solid var(--accent-color-1); 
            text-align: center;
            display: grid;
            grid-template-areas:
                "header"
                "config"
                "controls"
                "status"
                "video";
            gap: 20px; 
        }

        h1 { grid-area: header; font-family: 'Orbitron', sans-serif; color: var(--accent-color-1); font-size: 2.5rem; text-shadow: 0 0 10px var(--accent-color-1); letter-spacing: 3px; }

        /* Estilo para el nuevo panel de configuración */
        .config-panel {
            grid-area: config;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px dashed var(--accent-color-1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .config-panel input {
            background: #0d0d1a;
            border: 1px solid var(--accent-color-1);
            color: var(--accent-color-1);
            padding: 8px 15px;
            border-radius: 5px;
            font-family: 'Orbitron', sans-serif;
            text-align: center;
        }

        .controls { grid-area: controls; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        #statusText { grid-area: status; padding: 15px; border-radius: 8px; border: 1px solid var(--accent-color-2); background: #0d0d1a; color: var(--accent-color-1); font-weight: bold; }
        .video-wrapper { grid-area: video; border: 1px solid var(--accent-color-1); border-radius: 10px; overflow: hidden; }
        
        button {
            padding: 15px 30px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            border-radius: 40px;
            width: 100%;
            max-width: 350px;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        #btnStart { background-color: var(--button-green); color: var(--text-dark); }
        #btnRutina2 { background-color: var(--button-blue); color: var(--text-dark); }
        #btnReset { background-color: var(--button-red); color: var(--text-light); }
        
        button:hover { transform: scale(1.02); filter: brightness(1.2); }

        @media (min-width: 768px) {
            .container {
                grid-template-columns: 1fr 1fr;
                grid-template-areas:
                    "header header"
                    "config config"
                    "controls video"
                    "status video";
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ROBOT 7 7GDL</h1>
    
    <div class="config-panel">
        <label for="ipInput">IP DEL ROBOT:</label>
        <input type="text" id="ipInput" value="10.49.105.124" placeholder="Ej: 192.168.1.50">
        <span style="font-size: 0.8rem; opacity: 0.7;">(Se actualiza al instante)</span>
    </div>

    <div class="controls">
        <button id="btnStart" onclick="startRoutine()">RUTINA 1 (Servos)</button>
        <button id="btnRutina2" onclick="startRoutine2()">RUTINA 2 (Carro + Comp)</button>
        <button id="btnReset" onclick="resetRoutine()">RESET</button>
    </div>

    <p id="statusText">Estado: Inicializando...</p>

    <div class="video-wrapper">
        <video controls autoplay muted loop poster="https://placehold.co/650x366/302b63/00f0ff?text=FEED+DE+CÁMARA">
            <source src="video solid.mp4" type="video/mp4">
        </video>
    </div>
</div>

<script>
    let isExecuting = false;

    // Función para obtener la IP actual del cuadro de texto
    function getArduinoIP() {
        return document.getElementById('ipInput').value.trim();
    }

    function updateStatus(text, isSuccess) {
        const statusElement = document.getElementById('statusText');
        statusElement.innerText = 'Estado de Yarbito: ' + text;
        const color = isSuccess ? 'var(--accent-color-1)' : 'var(--button-red)';
        statusElement.style.color = color;
        statusElement.style.borderColor = color;
    }

    async function sendCommand(command, successMessage, failureMessage) {
        if (isExecuting) {
            updateStatus('Espera, comando en proceso...', false);
            return;
        }

        const currentIP = getArduinoIP();
        updateStatus('Enviando a ' + currentIP + '...', true);
        isExecuting = true; 
        
        const url = 'http://' + currentIP + command; 

        try {
            // Timeout de 5 segundos para no esperar siempre
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);

            const response = await fetch(url, { signal: controller.signal }); 
            clearTimeout(timeoutId);
            
            if (response.ok) {
                updateStatus(successMessage, true);
            } else {
                updateStatus(failureMessage + ' (Error ' + response.status + ')', false);
            }
        } catch (error) {
            updateStatus('ERROR: No hay conexión con ' + currentIP, false);
            console.error('Error:', error); 
        } finally {
            setTimeout(() => { isExecuting = false; }, 500); 
        }
    }

    function startRoutine() { sendCommand('/start', 'Rutina 1 activa.', 'Fallo Rutina 1.'); }
    function startRoutine2() { sendCommand('/rutina2', 'Rutina 2 activa.', 'Fallo Rutina 2.'); }
    function resetRoutine() { sendCommand('/reset', 'Sistema en reposo.', 'Fallo Reset.'); }

    window.onload = function() {
        updateStatus('Listo. IP actual: ' + getArduinoIP(), true);
    };
</script>

</body>
</html>